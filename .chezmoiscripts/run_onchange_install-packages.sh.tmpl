#!/bin/bash

{{ if eq .chezmoi.os "darwin" -}}
# Brewfile hash: {{ include "dot_config/Brewfile" | sha256sum }}

if command -v brew >/dev/null 2>&1; then
  if [ -f "$HOME/.config/Brewfile" ]; then
    echo "📦 Updating macOS packages via Homebrew..."
    brew bundle --file "$HOME/.config/Brewfile"
  else
    echo "⚠️  Brewfile not found at ~/.config/Brewfile, skipping package installation"
    echo "   This is normal on first run. Run 'chezmoi apply' again after completion."
  fi
else
  echo "🛑 Homebrew is required, but was not installed. See: https://brew.sh"
  exit 1
fi

{{ else if eq .chezmoi.os "linux" -}}
# Ubuntu packages hash: {{ include "dot_config/packages.ubuntu" | sha256sum }}

if command -v apt >/dev/null 2>&1; then
  if [ -f "$HOME/.config/packages.ubuntu" ]; then
    echo "📦 Updating Ubuntu packages via APT..."

    # Update package lists
    sudo apt update

    # Read package list and install
    # Filter out comments and empty lines
    packages=$(grep -v '^#' "$HOME/.config/packages.ubuntu" | grep -v '^$' | tr '\n' ' ')

    if [ -n "$packages" ]; then
      echo "Installing packages: $packages"
      sudo apt install -y $packages
    else
      echo "⚠️  No packages found in packages.ubuntu"
    fi

    echo "✅ Package installation complete."
  else
    echo "⚠️  packages.ubuntu not found at ~/.config/packages.ubuntu, skipping package installation"
    echo "   This is normal on first run. Run 'chezmoi apply' again after completion."
  fi
else
  echo "🛑 APT package manager not found. Are you running Ubuntu/Debian?"
  exit 1
fi

{{ end -}}

