#!/bin/bash

set -e

{{ if eq .chezmoi.os "darwin" -}}
#################
# macOS - Homebrew
#################

# Check if Homebrew is installed
if command -v brew >/dev/null 2>&1; then
    echo "âœ… Homebrew is already installed at $(command -v brew)"
else
    echo "ðŸš€ Homebrew not found. Installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH depending on architecture
    if [[ -d "/opt/homebrew/bin" ]]; then
        echo 'export PATH="/opt/homebrew/bin:$PATH"' >> ~/.bash_profile
        export PATH="/opt/homebrew/bin:$PATH"
    elif [[ -d "/usr/local/bin" ]]; then
        echo 'export PATH="/usr/local/bin:$PATH"' >> ~/.bash_profile
        export PATH="/usr/local/bin:$PATH"
    fi

    echo "âœ… Homebrew installation complete."
fi

#################
# Fish Shell
#################
if command -v fish >/dev/null 2>&1; then
    echo "âœ… Fish shell is already installed at $(command -v fish)"
else
    echo "ðŸš€ Fish shell not found. Installing..."
    brew install fish
    echo "Your password may be required to enable the Fish shell..."
    sudo sh -c "echo /opt/homebrew/bin/fish >> /etc/shells"
    chsh -s /opt/homebrew/bin/fish
fi

{{ else if eq .chezmoi.os "linux" -}}
#################
# Linux - APT
#################

echo "ðŸ§ Setting up Linux environment..."

# Check if we have sudo privileges
HAS_SUDO=false
if sudo -n true 2>/dev/null; then
    HAS_SUDO=true
    echo "âœ… Running with sudo privileges"
else
    echo "â„¹ï¸  Running without sudo (user-space installation)"
fi

# Update package lists (only if we have sudo)
if [ "$HAS_SUDO" = true ]; then
    echo "ðŸ“¦ Updating package lists..."
    sudo apt update
fi

#################
# Install required packages for PPA management
#################
if [ "$HAS_SUDO" = true ]; then
    echo "ðŸ“¦ Installing software-properties-common..."
    sudo apt install -y software-properties-common
fi

#################
# Fish Shell
#################
if command -v fish >/dev/null 2>&1; then
    echo "âœ… Fish shell is already installed at $(command -v fish)"
    FISH_PATH=$(which fish)
else
    if [ "$HAS_SUDO" = true ]; then
        echo "ðŸš€ Installing Fish shell via PPA..."
        sudo apt-add-repository ppa:fish-shell/release-3 -y
        sudo apt update
        sudo apt install fish -y
        FISH_PATH=$(which fish)
        echo "âœ… Fish shell installation complete."
    else
        echo "âš ï¸  Cannot install Fish shell without sudo."
        echo "   Fish may already be installed by system admin, or you can:"
        echo "   - Ask admin to install: sudo apt install fish"
        echo "   - Use existing shell"
        FISH_PATH=""
    fi
fi

# Set Fish as default shell (only if Fish is available)
if [ -n "$FISH_PATH" ] && [ -x "$FISH_PATH" ]; then
    echo "ðŸš Setting Fish as default shell..."

    # Add to /etc/shells if we have sudo
    if [ "$HAS_SUDO" = true ]; then
        if ! grep -q "$FISH_PATH" /etc/shells 2>/dev/null; then
            echo "$FISH_PATH" | sudo tee -a /etc/shells
        fi
    fi

    # Check current default shell
    CURRENT_SHELL=$(getent passwd "$USER" | cut -d: -f7)
    if [ "$CURRENT_SHELL" != "$FISH_PATH" ]; then
        if chsh -s "$FISH_PATH" 2>/dev/null; then
            echo "âœ… Fish set as default shell. Please logout and login again for this to take effect."
        else
            echo "â„¹ï¸  Could not set Fish as default shell (may need admin approval)"
            echo "   Ask admin to run: sudo chsh -s $FISH_PATH $USER"
        fi
    else
        echo "âœ… Fish is already the default shell."
    fi
fi

#################
# Essential tools (via curl installers)
#################
echo "ðŸ”§ Installing essential tools via curl installers..."

# Starship prompt
if ! command -v starship >/dev/null 2>&1; then
    echo "ðŸš€ Installing Starship prompt..."
    mkdir -p "$HOME/.local/bin"
    if [ "$HAS_SUDO" = true ]; then
        # Install to /usr/local/bin with sudo
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    else
        # Install to ~/.local/bin without sudo
        curl -sS https://starship.rs/install.sh | sh -s -- -y -b "$HOME/.local/bin"
    fi
    echo "âœ… Starship installed"
fi

# uv (Python package manager)
if ! command -v uv >/dev/null 2>&1; then
    echo "ðŸ“¦ Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    echo "âœ… uv installed"
fi

#################
# eza (better ls)
#################
if ! command -v eza >/dev/null 2>&1; then
    echo "ðŸ“¦ Installing eza..."
    mkdir -p "$HOME/.local/bin"
    wget -c https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz -O - | tar xz
    chmod +x eza
    mv eza "$HOME/.local/bin/eza"
    echo "âœ… eza installed to ~/.local/bin"
fi

#################
# git-delta (better git diff)
#################
if ! command -v delta >/dev/null 2>&1; then
    echo "ðŸ“¦ Installing git-delta..."
    mkdir -p "$HOME/.local/bin"
    DELTA_VERSION=$(curl -s https://api.github.com/repos/dandavison/delta/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
    wget "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/delta-${DELTA_VERSION}-x86_64-unknown-linux-gnu.tar.gz" -O /tmp/delta.tar.gz
    tar -xzf /tmp/delta.tar.gz -C /tmp
    mv "/tmp/delta-${DELTA_VERSION}-x86_64-unknown-linux-gnu/delta" "$HOME/.local/bin/"
    chmod +x "$HOME/.local/bin/delta"
    rm -rf /tmp/delta.tar.gz "/tmp/delta-${DELTA_VERSION}-x86_64-unknown-linux-gnu"
    echo "âœ… git-delta installed to ~/.local/bin"
fi

#################
# lazygit (git TUI)
#################
if ! command -v lazygit >/dev/null 2>&1; then
    echo "ðŸ“¦ Installing lazygit..."
    mkdir -p "$HOME/.local/bin"
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    wget "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" -O /tmp/lazygit.tar.gz
    tar -xzf /tmp/lazygit.tar.gz -C /tmp
    mv /tmp/lazygit "$HOME/.local/bin/"
    chmod +x "$HOME/.local/bin/lazygit"
    rm /tmp/lazygit.tar.gz
    echo "âœ… lazygit installed to ~/.local/bin"
fi

#################
# zellij (terminal multiplexer)
#################
if ! command -v zellij >/dev/null 2>&1; then
    echo "ðŸ“¦ Installing zellij..."
    mkdir -p "$HOME/.local/bin"
    ZELLIJ_VERSION=$(curl -s https://api.github.com/repos/zellij-org/zellij/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
    wget "https://github.com/zellij-org/zellij/releases/download/${ZELLIJ_VERSION}/zellij-x86_64-unknown-linux-musl.tar.gz" -O /tmp/zellij.tar.gz
    tar -xzf /tmp/zellij.tar.gz -C /tmp
    mv /tmp/zellij "$HOME/.local/bin/"
    chmod +x "$HOME/.local/bin/zellij"
    rm /tmp/zellij.tar.gz
    echo "âœ… zellij installed to ~/.local/bin"
fi

#################
# Create symlinks for renamed commands
#################
echo "ðŸ”— Creating symlinks for commands with different names on Ubuntu..."

mkdir -p "$HOME/.local/bin"

# bat -> batcat
if command -v batcat >/dev/null 2>&1 && ! command -v bat >/dev/null 2>&1; then
    ln -sf "$(which batcat)" "$HOME/.local/bin/bat"
fi

# fd -> fdfind
if command -v fdfind >/dev/null 2>&1 && ! command -v fd >/dev/null 2>&1; then
    ln -sf "$(which fdfind)" "$HOME/.local/bin/fd"
fi

echo "âœ… Linux setup complete."

{{ end -}}
